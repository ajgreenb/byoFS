<!DOCTYPE html>
<html style="height:100%">
    <head>
        <title>Bring Your Own Chat - Proof of Concept</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <script src="../../byoFS.js"></script>
        <script src="../../byoFS-ui.js"></script>
        <script src="rsa.min.js"></script>
        <style>
            /*http://meyerweb.com/eric/tools/css/reset/ v2.0 | 20110126 License: none (public domain)*/
            html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small,
            strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas,
            details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {margin:0; padding:0; border:0; font-size:100%; font:inherit; vertical-align:baseline;}
            /* HTML5 display-role reset for older browsers */
            article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section {display:block;} body {line-height: 1;} ol, ul {list-style: none;}
            blockquote, q {quotes: none;} blockquote:before, blockquote:after, q:before, q:after {content:''; content:none;} table {border-collapse:collapse; border-spacing:0;}
        </style>
        <style>
            /*App CSS goes here*/
            #widget{float:right;}
            body{font-family:sans-serif;background-color:#f3f3f3;color:#333333;height:100%;}
            #modal-background{position:absolute;background-color:#ffffff;opacity:0.9;height:100%;width:100%;text-align:center;z-index:98;}
            #modal-wrapper{position:absolute;width:100%;text-align:center;opacity:0.9;z-index:99;}
            #modal{display:inline-block;background-color:#dddddd;padding:10px;margin-top:50px;width:420px;opacity:1.0;border-radius:5px;}
            #modal-X{float:right;text-decoration:none;color:#999999;font-size:15px;}
            #modal-title{padding:10px 0px;}
            #modal-txt{width:400px;height:150px;}
            #modal-close{padding:5px;border:0;border-radius:0;background-color:#333333;color:#f3f3f3;width:90px;}
            #header{z-index:2;display:block;position:absolute;left:0px;top:0px;width:calc(100% - 20px);padding:10px;}
            #desc{display:inline-block;text-decoration:none;border-bottom: 1px dashed #333333;color:#333333;}
            #header h1{height:24px;overflow:hidden;font-size:18px;font-weight:bold;}
            #state{height:16px;overflow:hidden;font-size:14px;font-style:italic;}
            #settings-row{height:40px;overflow:hidden;}
            #setup{display:inline-block;margin-top:15px;}
            #setup li{display:inline-block;margin-right:5px;}
            #setup a{padding:5px;font-size:14px;border:1px solid #333333;text-decoration:none;background-color:#333333;color:#f3f3f3;}
            #saved{display:inline-block;}
            #saved select{background:#dddddd;padding:5px;font-size:14px;line-height:1;border:1px solid #333333;border-radius:0;}
            #content{width:calc(100% - 40px);margin:10px;padding:10px;border:1px solid #333333;background-color:#f3f3f3;position:fixed;top:85px;bottom:0px;}
            #close{display:block;position:absolute;right:3px;top:3px;text-decoration:none;color:#999999;font-size:15px;}
            #close:hover{color:#333333;}
            #chat{display:block;position:absolute;bottom:30px;top:10px;width:calc(100% - 50px);background-color:#dddddd;padding:10px;margin-bottom:10px;overflow-y:auto;}
            .line{background-color:#f3f3f3;margin:5px 10px;display:inline-block;padding:10px;}
            .right{text-align:right;}
            .right .line{border-radius:10px 10px 0 10px;}
            .left{text-align:left;}
            .left .line{border-radius:10px 10px 10px 0;}
            .author{font-family:monospace;font-size:14px;}
            .message{font-size:16px;font-family:serif;padding-top:10px;}
            #content form{display:block;position:absolute;bottom:5px;width:calc(100% - 20px);}
            #in{padding:5px;border:1px solid #333333;border-radius:0;width:calc(100% - 114px);min-width:50%;}
            #go{padding:5px;border:0;border-radius:0;background-color:#333333;color:#f3f3f3;width:90px;}
        </style>
    </head>
    <body>
        <!--HTML Goes Here-->
        <div id="modal-background" style="display:none;"></div>
        <div id="modal-wrapper" style="display:none;">
            <div id="modal">
                <a href="#" id="modal-X">X</a>
                <p id="modal-title">Copy the text below.</p>
                <textarea id="modal-txt">My text to copy</textarea>
                <button id="modal-submit">Close</button>
            </div>
        </div>
        <div id="header">
            <div id="widget"></div>
            <h1>
                <a href="#" id="desc" title="description">Bring Your Own Chat</a>
                (an example <a href="https://github.com/diafygi/byoFS" target="_blank">byoFS</a> app)
            </h1>
            <div id="state"></div>
            <div id="settings-row">
                <ul id="setup">
                    <li><a id="gen_code" href="#">Create a new chat code</a></li>
                    <li><a id="get_code" href="#">Received a chat code?</a></li>
                </ul>
                <!--TODO: Implement saved chats-->
                <div id="saved" style="display:none;">
                    <select id="saved-list">
                        <option value="blank_state" selected>Previously Saved Chats</option>
                        <option value="load_123456">Chat 123456</li>
                        <option value="load_123457">Chat 123456</li>
                        <option value="load_123458">Chat 123456</li>
                    </select>
                </div>
            </div>
        </div>
        <div id="content">
            <a id="close" href="#" title="close">X</a>
            <div id="chat">
                <div class="left">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">diafygi:</div>
                        <div class="message">Howdy :)</div>
                    </div>
                </div>
                <div class="right">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">zaki:</div>
                        <div class="message">This is my message!</div>
                    </div>
                </div>
                <div class="left">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">diafygi:</div>
                        <div class="message">I received your message</div>
                    </div>
                </div>
                <div class="right">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">zaki:</div>
                        <div class="message">10-4 good buddy</div>
                    </div>
                </div>
                <div class="left">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">diafygi:</div>
                        <div class="message">Howdy :)</div>
                    </div>
                </div>
                <div class="right">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">zaki:</div>
                        <div class="message">This is my message!</div>
                    </div>
                </div>
                <div class="left">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">diafygi:</div>
                        <div class="message">I received your message</div>
                    </div>
                </div>
                <div class="right">
                    <div class="line">
                        <div class="author" title="2014-01-01 01:21:34 UTC">zaki:</div>
                        <div class="message">10-4 good buddy</div>
                    </div>
                </div>
            </div>
            <form>
                <input id="in" placeholder="type message here"/>
                <input id="go" type="submit" value="Submit"/>
            </form>
        </div>

        <!--App code goes here-->
        <script>
            //global settings
            var BITS = 512; //TODO: make this 2048 or 4096 bits in a worker thread
            var fs;
            var local_cache = {};
            var remote_cache = {};
            var CHECK_INTERVAL = 2000;
            var WAIT_ID;
            var WAIT = null;
            var MONITOR_ID;
            var MONITOR = null;
            var MODAL_FN = null;
            var index = {};
            /*
            index format = {
                "<chat_id>": {
                    "local": {
                        "pub": <local_public_key_string>,
                        "pub_url": <public_url_of_local_public_key>,
                        "priv": <local_private_key_string>,
                        "key": <shared_key_string>,
                        "key_url": <public_url_of_shared_key_encrypted_with_remote_public_key>,
                        "log_url": <public_url_of_local_side_of_chat>,
                    },
                    "remote": {
                        "pub": <remote_public_key_string>,
                        "pub_url": <public_url_of_remote_public_key>,
                        "key_url": <public_url_of_shared_key_encrypted_with_local_public_key>,
                        "log_url": <public_url_of_remote_chat_log_encrypted_with_shared_key>,
                    },
                }
            }
            */

            //create new password to be shared
            function new_pass(len){
                var pass_array = new Uint32Array(64);
                window.crypto.getRandomValues(pass_array);
                var pass = "";
                for (var i = 0; i < pass_array.length; i++) {
                    pass += pass_array[i].toString(16);
                }
                return pass.substring(0, len);
            }

            //create new public private key pair
            function new_rsa(){
                var rsa1 = new RSAKey();
                rsa1.generate(BITS, "10001");
                return {
                    "pub": rsa1.n.toString(16) + "," + rsa1.e.toString(16),
                    "priv": rsa1.n.toString(16) + "," + rsa1.e.toString(16) + "," + rsa1.d.toString(16) + "," + rsa1.p.toString(16) + "," + rsa1.q.toString(16) + "," + rsa1.dmp1.toString(16) + "," + rsa1.dmq1.toString(16) + "," + rsa1.coeff.toString(16),
                }
            }

            //encrypt string with public key
            function enc_rsa(str, pubstr){
                var rsa2 = new RSAKey();
                var pub = pubstr.split(",");
                rsa2.setPublic(pub[0], pub[1]);
                return rsa2.encrypt(str);
            }

            //decyrpt string with private key
            function dec_rsa(str, privstr){
                var rsa3 = new RSAKey();
                var priv = privstr.split(",");
                rsa3.setPrivateEx(priv[0], priv[1], priv[2], priv[3], priv[4], priv[5], priv[6], priv[7]);
                return rsa3.decrypt(str);
            }

            //close modal overlay
            function close_modal(e){
                if(e !== undefined){
                    e.preventDefault();
                }
                document.getElementById("modal-background").style.display = "none";
                document.getElementById("modal-wrapper").style.display = "none";
            }

            //show modal for copying/pasting codes
            function show_modal(title, txt, submit_txt, callback){
                document.getElementById("modal-background").style.display = "block";
                document.getElementById("modal-wrapper").style.display = "block";

                document.getElementById("modal-title").innerHTML = title;
                document.getElementById("modal-txt").value = txt;
                document.getElementById("modal-submit").innerHTML = submit_txt;

                //add close events
                document.getElementById("modal-X").removeEventListener("click", close_modal);
                document.getElementById("modal-X").addEventListener("click", close_modal);
                document.getElementById("modal-submit").removeEventListener("click", close_modal);
                document.getElementById("modal-submit").addEventListener("click", close_modal);

                //remove any previous events
                if(MODAL_FN !== null){
                    document.getElementById("modal-submit").removeEventListener("click", MODAL_FN);
                }

                //add a callback event
                MODAL_FN = null;
                if(callback !== undefined){
                    MODAL_FN = callback;
                    document.getElementById("modal-submit").addEventListener("click", callback);
                }
            }

            //show a popup of the code
            function show_code(e, code){
                if(e !== undefined){
                    e.preventDefault();
                    if(code === undefined){
                        code = e.target.title;
                    }
                }
                var base_url = document.location.href.split("?")[0];
                var base_noanchors = base_url.split("#")[0];
                var share_url = base_noanchors + "?" + code;
                show_modal("Copy the below code or <a target='_blank' href='" + share_url + "'>this link</a> and send it to the person you want to chat with.", code, "Close", undefined);
            }

            //search current index for public key reference
            function search_using_ref(ref){
                for(var k in index){
                    if(index[k]['local'] !== undefined && index[k]['local']['pub_url'] === ref)
                        return k;
                }
                return null;
            }

            function create_message(e){
                e.preventDefault();
                document.getElementById("state").innerHTML = "Creating new message...";

                //pause monitor and unbind message submission until new message is created
                stop_monitor();
                document.getElementById("go").value = "Saving...";
                document.getElementById("go").removeEventListener('click', create_message, false);

                //push new message to local cache
                var create_id = MONITOR_ID.toString(); //deep copy id
                local_cache[MONITOR_ID].push({
                    "ts": new Date().getTime(),
                    "v": document.getElementById("in").value,
                });

                //push local cache to storage
                var updated_log = sjcl.encrypt(index[create_id]['local']['key'], JSON.stringify(local_cache[create_id]));
                fs.write({"name": "log-"+create_id, "pub": true}, JSON.stringify(updated_log), function(pxhr){
                    //re-bind and restart monitor
                    document.getElementById("state").innerHTML = "New message saved!";
                    render_cached_messages();
                    document.getElementById("go").addEventListener("click", create_message);
                    document.getElementById("go").value = "Submit";
                    document.getElementById("in").value = "";
                    start_monitor();
                });
            }

            //render and insert html based on javascript log caches
            //NOTE: This is enormously inefficienct because it renders the whole chat.
            //      It would be much better if it looked at the current render and only updated the differences.
            //      Didn't have time for that, though.
            function render_cached_messages(){

                //combine both local and remote into one message list
                var comb_list = [];
                var render_id = MONITOR_ID.toString(); //deep copy id
                if(local_cache[render_id] !== undefined)
                    for(var i = 0; i < local_cache[render_id].length; i++)
                        comb_list.push({
                            "author": "you",
                            "timestamp": local_cache[render_id][i]['ts'],
                            "message": local_cache[render_id][i]['v'],
                        });
                if(remote_cache[render_id] !== undefined)
                    for(var i = 0; i < remote_cache[render_id].length; i++)
                        comb_list.push({
                            "author": "them",
                            "timestamp": remote_cache[render_id][i]['ts'],
                            "message": remote_cache[render_id][i]['v'],
                        });

                //order messages based on timestamp
                comb_list.sort(function(a, b){
                    if(a['timestamp'] < b['timestamp'])
                        return -1;
                    if(a['timestamp'] > b['timestamp'])
                        return 1;
                    return 0;
                });

                //generate and insert html
                var out = "";
                for(var i = 0; i < comb_list.length; i++){
                    var m = comb_list[i];
                    var side = m['author'] === "them" ? "left": "right";
                    out += '<div class="' + side + '">';
                    out += '    <div class="line">';
                    out += '        <div class="author" title="' + (new Date(m['timstamp'])).toUTCString() + '">' + m['author'] + ':</div>';
                    out += '        <div class="message">' + m['message'] + '</div>';
                    out += '    </div>';
                    out += '</div>';
                }
                document.getElementById("chat").innerHTML = out;
                document.getElementById("state").innerHTML = "Chat is up to date!";
            }

            //check currently monitoried chat's remote log for updates
            function check_chat(){
                stop_monitor();
                document.getElementById("state").innerHTML = "Checking for new messages...";

                //request remote chat log
                var check_id = MONITOR_ID.toString(); //deep copy id
                var xhr_check = new XMLHttpRequest();
                xhr_check.open("GET", index[check_id]['remote']['log_url']);
                xhr_check.onreadystatechange = function(){
                    if(xhr_check.readyState === 4){
                        if(xhr_check.status !== 200){
                            document.getElementById("state").innerHTML = "Check failed...Trying again in " + parseInt(CHECK_INTERVAL/1000) +  " sec...";
                            start_monitor();
                        }
                        else{
                            //decrypt remote log
                            var tmp_log = sjcl.decrypt(index[check_id]['local']['key'], JSON.parse(xhr_check.responseText));
                            if(typeof(tmp_log) === "string")
                                tmp_log = JSON.parse(tmp_log);
                            //checked cached remote length vs. new remote length
                            if(typeof(tmp_log) === "object" && (remote_cache[check_id] === undefined || tmp_log.length !== remote_cache[check_id].length)){
                                remote_cache[check_id] = tmp_log;
                                document.getElementById("state").innerHTML = "Updating...";
                                render_cached_messages();
                            }
                            else{
                                document.getElementById("state").innerHTML = "No new messages found.";
                            }
                            start_monitor();
                        }
                    }
                };
                xhr_check.send();
            }

            //stop monitoring for updates
            function stop_monitor(){
                if(MONITOR !== null)
                    clearInterval(MONITOR);
            }

            //start monitoring for updates
            function start_monitor(){
                stop_monitor();
                MONITOR = setInterval(check_chat, CHECK_INTERVAL);
            }

            //update chat history dropdown based on index
            function update_history(){
                var out = '<option value="blank_state" selected>Previously Saved Chats</option>';
                for(var k in index)
                    out += '<option value="' + k + '">Chat ' + k + '</li>';
                document.getElementById("saved-list").innerHTML = out;
                document.getElementById("saved-list").addEventListener("change", function(e){
                    console.log(e.target);
                    //######################change event trigger for dropdown chat history#############
                });
            }

            //close chat and stop monitoring
            function close_chat(){
                stop_monitor();
                document.getElementById("content").style.display = "none";
                update_history();
                document.getElementById("state").innerHTML = "Closed chat.";
            }

            //reload chat window with selected chat
            function init_chat(chat_id){
                //assign global current chat id variable
                MONITOR_ID = chat_id;

                //show and clear chat window
                document.getElementById("content").style.display = "block";
                document.getElementById("chat").innerHTML = "";

                //load cached chats
                render_cached_messages();

                //bind buttons
                document.getElementById("close").addEventListener("click", close_chat);
                document.getElementById("go").addEventListener("click", create_message);

                //check remote chat and start monitor
                check_chat();
            }

            //you're ready to chat, but you need to wait for remote to confirm the key
            function wait_chat(chat_id){
                //cancel interval while checking wait
                if(chat_id === undefined)
                    chat_id = WAIT_ID;
                WAIT_ID = chat_id;
                if(WAIT !== null)
                    clearInterval(WAIT);

                //check to see if remote is setup
                var wait_id = WAIT_ID.toString(); //deep copy id
                var xhr_wait = new XMLHttpRequest();
                xhr_wait.open("GET", index[wait_id]['remote']['log_url']);
                xhr_wait.onreadystatechange = function(){
                    if(xhr_wait.readyState === 4){
                        if(xhr_wait.status !== 200){
                            WAIT = setInterval(wait_chat, CHECK_INTERVAL);
                        }
                        else{
                            //decrypt remote log
                            if(xhr_wait.responseText !== "" && xhr_wait.responseText !== null)
                                init_chat(wait_id);
                            else
                                WAIT = setInterval(wait_chat, CHECK_INTERVAL);
                        }
                    }
                };
                xhr_wait.send();
            }

            //generate a new public key
            function gen_code(e, callback){
                if(e !== null)
                    e.preventDefault();

                //stop any existing chat
                close_chat();

                //gen new id
                document.getElementById("state").innerHTML = "Generating new chat code...";
                var id = new_pass(8);
                while(index[id] !== undefined)
                    id = new_pass(8);

                //generate new key pair
                var kp = new_rsa();
                index[id] = {"local": kp};

                //write public key to file
                document.getElementById("state").innerHTML = "Saving new key pair...";
                fs.write({"name": "pub-"+id, "pub": true}, kp['pub'], function(pxhr){
                    //update index with new key pair and public url
                    index[id]['local']['pub_url'] = pxhr.responseText;

                    //generate placeholder key file
                    document.getElementById("state").innerHTML = "Saving new shared key...";
                    fs.write({"name": "key-"+id, "pub": true}, "", function(pxhr){
                        index[id]['local']['key_url'] = pxhr.responseText;

                        //generate placeholder log file
                        document.getElementById("state").innerHTML = "Saving new chat...";
                        fs.write({"name": "log-"+id, "pub": true}, "", function(pxhr){
                            index[id]['local']['log_url'] = pxhr.responseText;

                            //generate placeholder log file
                            document.getElementById("state").innerHTML = "Chat created! Updating index...";
                            update_index(function(){
                                //if there was a callback, call that
                                if(callback !== undefined){
                                    callback(id);
                                }
                                //no callback defaults to showing code
                                else{
                                    var b64_code = window.btoa(JSON.stringify({
                                        "pub": index[id]['local']['pub_url'],
                                        "key": index[id]['local']['key_url'],
                                        "log": index[id]['local']['log_url'],
                                    }));
                                    document.getElementById("state").innerHTML = 'Here is your <a id="new_b64_code" href="#" title="'+b64_code+'">chat code</a>.';
                                    document.getElementById("new_b64_code").addEventListener("click", show_code);
                                    show_code(undefined, b64_code);
                                }
                            });
                        });

                    });
                });
            }

            //get user to input received chat code
            function input_code(e){
                e.preventDefault();
                document.getElementById("state").innerHTML = "Waiting for chat code <a href='#' id='get-input-code'>input</a>...";
                document.getElementById("get-input-code").addEventListener("click", input_code);
                show_modal("Paste the code you received.", "", "Submit", get_code);
            }

            //input a remote public key
            function get_code(){
                //get chat code from modal input
                var conf = document.getElementById("modal-txt").value;
                if(conf === null || conf === "")
                    return;
                close_chat();

                //remove the url if the code contains a url
                if(conf.split("?").length > 1){
                    conf = conf.split("?")[1];
                }

                //convert chat code to chat config
                try{
                    conf = JSON.parse(window.atob(conf));
                }
                catch(err){
                    document.getElementById("state").innerHTML = "The code supplied doesn't seem to work :( <a href='#' id='get-input-code'>Try another code</a>";
                    document.getElementById("get-input-code").addEventListener("click", input_code);
                    return;
                }

                //retrieve public key
                document.getElementById("state").innerHTML = "Retrieving their public key...";
                var xhr = new XMLHttpRequest();
                xhr.open("GET", conf['pub']);
                xhr.onreadystatechange = function(){
                    if(xhr.readyState === 4){
                        if(xhr.status !== 200){
                            document.getElementById("state").innerHTML = "Error retrieving their public key :(";
                        }
                        else{
                            //see if any existing chats that are based on one of the local public key urls
                            var remote_pub = xhr.responseText;
                            var cur_id = search_using_ref(conf['ref']);

                            //no existing chat, so make a new one
                            if(cur_id === null){
                                document.getElementById("state").innerHTML = "No existing chat matches, creating new...";
                                //create placeholder files
                                gen_code(null, function(new_id){

                                    //update placeholder files using received public key
                                    document.getElementById("state").innerHTML = "Creating new shared key...";
                                    index[new_id]['local']['key'] = new_pass(parseInt(BITS / 16 - 6));
                                    var enc_key = enc_rsa(index[new_id]['local']['key'], remote_pub);
                                    fs.write({"name": "key-"+new_id, "pub": true}, enc_key, function(pxhr){
                                        index[new_id]['local']['key_url'] = pxhr.responseText;

                                        //update chat log placeholder with shared key
                                        document.getElementById("state").innerHTML = "Creating new chat...";
                                        local_cache[new_id] = [];
                                        var new_log = sjcl.encrypt(index[new_id]['local']['key'], JSON.stringify(local_cache[new_id]));
                                        fs.write({"name": "log-"+new_id, "pub": true}, JSON.stringify(new_log), function(pxhr){
                                            index[new_id]['local']['log_url'] = pxhr.responseText;

                                            //update the index with all the new configuration
                                            document.getElementById("state").innerHTML = "Updating index with new chat...";
                                            index[new_id]['remote'] = {
                                                "pub": remote_pub,
                                                "pub_url": conf['pub'],
                                                "key_url": conf['key'],
                                                "log_url": conf['log'],
                                            };
                                            update_index(function(){
                                                //show message with response code
                                                var b64_code = window.btoa(JSON.stringify({
                                                    "ref": index[new_id]['remote']['pub_url'],
                                                    "pub": index[new_id]['local']['pub_url'],
                                                    "key": index[new_id]['local']['key_url'],
                                                    "log": index[new_id]['local']['log_url'],
                                                }));
                                                document.getElementById("state").innerHTML = 'Chat created! Reply with this new <a id="new_b64_code" href="#" title="'+b64_code+'">chat code</a>.';
                                                document.getElementById("new_b64_code").addEventListener("click", show_code);
                                                show_code(undefined, b64_code);
                                                wait_chat(new_id);
                                            });
                                        });
                                    });
                                });
                            }
                            //chat exists!
                            else{
                                //ask for override if remote public key isnt the same as index value
                                if(index[cur_id]['remote'] !== undefined && index[cur_id]['remote']['pub'] !== remote_pub){
                                    if(!confirm("The person you are chatting with seems to have changed their key! Press OK to override and use their new key.")){
                                        document.getElementById("state").innerHTML = "Couldn't load chat :(";
                                        return;
                                    }
                                }
                                //update local shared key and chat log to match remote's
                                index[cur_id]['remote'] = {
                                    "pub": remote_pub,
                                    "pub_url": conf['pub'],
                                    "key_url": conf['key'],
                                    "log_url": conf['log'],
                                }
                                //get shared key from remote
                                document.getElementById("state").innerHTML = "Verifying chat key...";
                                var xhr_key = new XMLHttpRequest();
                                xhr_key.open("GET", conf['key']);
                                xhr_key.onreadystatechange = function(){
                                    if(xhr_key.readyState === 4){
                                        if(xhr_key.status !== 200){
                                            document.getElementById("state").innerHTML = "Error verifying their chat key :(";
                                        }
                                        else{
                                            //decrypt shared key using local private key
                                            var remote_shared = dec_rsa(xhr_key.responseText, index[cur_id]['local']['priv']);

                                            //ask for override if remote shared doesn't match
                                            if(index[cur_id]['local']['key'] !== undefined && index[cur_id]['local']['key'] !== remote_shared){
                                                if(!confirm("The shared chat encryption doesn't match! Press OK to override and re-encrypt using the received key.")){
                                                    document.getElementById("state").innerHTML = "Couldn't load chat :(";
                                                    return;
                                                }
                                            }

                                            //update shared key using remote public
                                            document.getElementById("state").innerHTML = "Updating chat key...";
                                            var enc_key = enc_rsa(remote_shared, index[cur_id]['remote']['pub']);
                                            fs.write({"name": "key-"+cur_id, "pub": true}, enc_key, function(pxhr){

                                                //re-encrypt using shared key if not the same (already asked for confirmation above)
                                                if(index[cur_id]['local']['key'] !== undefined && index[cur_id]['local']['key'] !== remote_shared){
                                                    document.getElementById("state").innerHTML = "Re-encrypting using new chat key...";
                                                    var xhr_re = new XMLHttpRequest();
                                                    xhr_re.open("GET", index[cur_id]['local']['log_url']);
                                                    xhr_re.onreadystatechange = function(){
                                                        if(xhr_re.readyState === 4){
                                                            if(xhr_re.status !== 200){
                                                                //re-encrypt
                                                                local_cache[cur_id] = sjcl.decrypt(index[cur_id]['local']['key'], JSON.parse(xhr_re.responseText));
                                                                var enc_log = sjcl.encrypt(remote_shared, JSON.stringify(local_cache[cur_id]));
                                                                //save re-encrypted file
                                                                fs.write({"name": "log-"+cur_id, "pub": true}, JSON.stringify(enc_log), function(pxhr){

                                                                    //update index
                                                                    document.getElementById("state").innerHTML = "Updating index with re-encryption...";
                                                                    index[cur_id]['local']['key'] = remote_shared;
                                                                    update_index(function(){
                                                                        document.getElementById("state").innerHTML = "Re-encrypted chat ready!";
                                                                        init_chat(cur_id);
                                                                    });
                                                                });
                                                            }
                                                        }
                                                    };
                                                    xhr_re.send();
                                                }
                                                //no previously existing shared key, so set the received one and initialize chat log
                                                else{
                                                    //encrypt new empty chat log
                                                    document.getElementById("state").innerHTML = "Creating new chat...";
                                                    local_cache[cur_id] = [];
                                                    var enc_log = sjcl.encrypt(remote_shared, JSON.stringify(local_cache[cur_id]));
                                                    //save initialized chat log
                                                    fs.write({"name": "log-"+cur_id, "pub": true}, JSON.stringify(enc_log), function(pxhr){

                                                        //update index
                                                        document.getElementById("state").innerHTML = "Updating index with new chat...";
                                                        index[cur_id]['local']['key'] = remote_shared;
                                                        update_index(function(){
                                                            document.getElementById("state").innerHTML = "New chat ready!";
                                                            init_chat(cur_id);
                                                        });
                                                    });
                                                }
                                            });

                                        }
                                    }
                                };
                                xhr_key.send();
                            }
                        }
                    }
                };
                xhr.send();
            }

            function load_data(chat_id){
                //load chat histories into dropdown
                update_history();

                //bind click events to gen/get code buttons
                document.getElementById("gen_code").addEventListener("click", gen_code);
                document.getElementById("get_code").addEventListener("click", input_code);

                //show settings-row
                document.getElementById("settings-row").style.display = "block";
                document.getElementById("state").innerHTML = "Ready to rock and roll!";

                //hide chat window if no chat selected
                if(chat_id === undefined){
                    document.getElementById("content").style.display = "none";

                    //see if there's a config in the url
                    var url_conf = document.location.search.substr(1);
                    if(url_conf !== ""){
                        document.getElementById("modal-txt").value = url_conf;
                        get_code();
                    }
                }
                else{
                    init_chat(chat_id);
                }
            }

            function reset_index(e){
                e.preventDefault();
                document.getElementById("state").innerHTML = "Resetting...";
                fs.write("index", null, function(){
                    update_index(load_data);
                });
            }

            function reload_page(e){
                e.preventDefault();
                document.getElementById("state").innerHTML = "Reloading...";
                location.reload();
            }

            function update_index(callback){
                //see if you can get the index
                fs.read("index", function(pxhr){
                    //no index, assume registration and create index file
                    if(pxhr.status === 404){
                        document.getElementById("state").innerHTML = "No index found, creating one...";
                        fs.write("index", JSON.stringify({}), function(){
                            update_index(callback);
                        });
                    }
                    //bad password
                    else if(pxhr.status === 401){
                        document.getElementById("state").innerHTML = "Couldn't decrypt with that password :( <a href='#' id='reload-page'>Try again</a> or <a href='#' id='reset-everything'>Reset everything</a>.";
                        document.getElementById("reload-page").addEventListener("click", reload_page);
                        document.getElementById("reset-everything").addEventListener("click", reset_index);
                    }
                    //some other error occurred
                    else if(pxhr.status !== 200){
                        alert("Something went wrong :(")
                        app_init();
                    }
                    //index found
                    else{
                        //compare local vs remote index
                        document.getElementById("state").innerHTML = "Parsing index...";
                        var remote_index = JSON.parse(pxhr.responseText);
                        var needs_update = false;

                        //three layers of keys to compare
                        //(chat_id, local/remote, and local/remote keys)
                        for(var k1 in index){
                            //see if any new chat ids
                            if(remote_index[k1] === undefined){
                                needs_update = true;
                                remote_index[k1] = index[k1];
                                continue;
                            }
                            for(var k2 in index[k1]){
                                //see if any new local/remote
                                if(remote_index[k1][k2] === undefined){
                                    needs_update = true;
                                    remote_index[k1][k2] = index[k1][k2];
                                    continue;
                                }
                                for(var k3 in index[k1][k2]){
                                    //see if any new keys in each local/remote
                                    if(remote_index[k1][k2][k3] !== index[k1][k2][k3]){
                                        needs_update = true;
                                        remote_index[k1][k2][k3] = index[k1][k2][k3];
                                    }
                                }
                            }
                        }
                        index = remote_index;

                        //update index if needed
                        if(needs_update){
                            fs.write("index", JSON.stringify(index), function(){
                                callback();
                            });
                        }
                        else{
                            callback();
                        }
                    }
                });
            }

            function app_init(){
                document.getElementById("state").innerHTML = "Click the Dropbox icon to connect! --->";
                document.getElementById("settings-row").style.display = "none";
                document.getElementById("content").style.display = "none";
                byoFS_UI("byoChat", "#widget", function(connected_fs){
                    fs = connected_fs;
                    document.getElementById("state").innerHTML = "Setting up...";
                    update_index(load_data);
                });
            }
            app_init();


            function show_description(e){
                e.preventDefault();
                show_modal("Description", "This is an example zero-knowledge, " +
                    "end-to-end encrypted chat that doesn't rely on any plugins. " +
                    "This is a static unhosted app (i.e. you can right-click and " +
                    "Save-As) that uses your Dropbox account as an encrypted " +
                    "storage backend so it can be served anywhere. NOTE: This is a " +
                    "proof-of-concept for the the byoFS project, and should only " +
                    "be used as an example. See https://github.com/diafygi/byoFS " +
                    "for more details.", "Close", undefined);
            }
            document.getElementById("desc").addEventListener("click", show_description);
        </script>
    </body>
</html>
